---
title: "MassDEP Stream IBI Summary Report"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  word_document:
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: no
subtitle: Metric Scores and Values
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results='asis', echo=FALSE, warning=FALSE, message = FALSE)
# needed for trouble shooting
boo_DEBUG <- FALSE
if(boo_DEBUG==TRUE){
  # myConfig <- file.path(system.file(package="ContDataQC"), "extdata", "config.ORIG.R")
  # source(myConfig)
}## IF ~ boo_DEBUG ~ END
```

# INTRODUCTION
The following document is dynamic - it changes depending on the data input into the Mass DEP R Shiny Application. 

Please refer to the "Data File Information" section for general properties of the input dataset used to genereate this report. 

Histograms in the "Plots" section will change depending on the input dataset. 

# DATA FILE INFORMATION
```{r data_file_info}
  # Results File
  df_metval <- df_metval
  df_metsc <- df_metsc

  # df_metval <- read.csv("C:/Users/Ben.Block/OneDrive - Tetra Tech, Inc/GitHub/results_metval_single.csv")
  # df_metsc <- read.csv("C:/Users/Ben.Block/OneDrive - Tetra Tech, Inc/GitHub/results_metsc_single.csv")
  
  # Report Info
  myReportDate <- format(Sys.time(), '%Y-%m-%d %H:%M:%S')
  cat(paste("**Report Date:** " ,myReportDate, "\n\n", sep=""))
  myUser <- Sys.getenv("USERNAME")
  cat(paste("**Generated By:** ", myUser, "\n\n", sep=""))
  
  # Number of Samples
  myNumRecords <- nrow(df_metval)
  cat(paste("**Number of Records:** ", myNumRecords, "\n\n", sep=""))
  
  # Period of Record
  df_metval$COLLDATE <- as.Date(df_metval$COLLDATE, format = "%m/%d/%Y")
  POR <- paste(min(df_metval$COLLDATE)," to ", max(df_metval$COLLDATE), sep="")
  cat(paste("**Period of Record:** ", POR, sep="", collapse="\n\n"))
```

# SUMMARY TABLES
### The tables below summarize the data that were input into the shiny app.
### Table 1. Number of sites by Index Narrative and Index Region. 
```{r Results_summary_table1, message=FALSE}
library(knitr)
library(tidyr)
library(dplyr)

options(dplyr.summarise.inform = FALSE)

df_scores <- df_metsc
df_scores$counts <- rep(1)

# create a vector in the desired order
row_ord <- c("Exceptional", "Satisfactory", "Moderately Degraded", "Severely Degraded")

table1 <- df_scores %>% 
  group_by(Index_Nar, INDEX_REGION) %>% 
  summarize(counts = sum(counts)) %>% 
  pivot_wider(names_from = INDEX_REGION,
              values_from = counts) %>% 
  mutate(Index_Nar = factor(Index_Nar, levels = row_ord)) %>% 
  arrange(Index_Nar) %>% 
  rename("Index Narrative" = Index_Nar)

kable(table1)

```

### Table 2. Index scores summary statistics by Index Region.
```{r Results_summary_table2, message=FALSE}
library(knitr)
library(tidyr)
library(readxl)

scores_trim <- df_scores %>% 
  select(INDEX_REGION, Index, counts)

table2_temp <- scores_trim %>% 
  group_by(INDEX_REGION) %>% 
  summarize(N = sum(counts),
            Min = round(min(Index), 1),
            q25 = round(quantile(Index, 0.25, na.rm = TRUE), 1),
            Med = round(median(Index, na.rm = TRUE), 1),
            q75 = round(quantile(Index, 0.75, na.rm = TRUE), 1),
            Max = round(max(Index),1))%>% 
  rename("Index Region" = INDEX_REGION)

# state directories
table.dir <- "tables"
table.file <- "Instruction_Tables.xlsx"
IBI_tab.dir <- "IBI_data"

IBI_data <- read_excel(file.path(table.dir, table.file), sheet = IBI_tab.dir
                     , na = c("NA", ""), trim_ws = TRUE, skip = 0
                     , col_names = TRUE)
table2 <- rbind(table2_temp, IBI_data)

kable(table2)

```


### Table 3. Metrics in the Western Highlands IBI, with scoring formulas. Trend is the direction of metric response with increasing stress. 
```{r Results_summary_table_3}
library(readxl)
library(knitr)
# state directories
table.dir <- "tables"
table.file <- "Instruction_Tables.xlsx"
tab3.dir <- "table2"

table3 <- read_excel(file.path(table.dir, table.file), sheet = tab3.dir
                     , na = c("NA", ""), trim_ws = TRUE, skip = 0
                     , col_names = TRUE)

kable(table3)
```

*Beckâ€™s Biotic Index = 2 x [Class 1 Taxa]+[Class 2 Taxa] where Class 1 taxa have tolerance values of 0 or 1 and Class 2 taxa have tolerance values of 2, 3 or 4.

### Table 4. Metrics in the Central Hills IBI, with scoring formulas. Trend is the direction of metric response with increasing stress.
```{r Results_summary_table_4}
library(readxl)
library(knitr)
# state directories
table.dir <- "tables"
table.file <- "Instruction_Tables.xlsx"
tab4.dir <- "table3"

table4 <- read_excel(file.path(table.dir, table.file), sheet = tab4.dir
                     , na = c("NA", ""), trim_ws = TRUE, skip = 0
                     , col_names = TRUE)

kable(table4)
```

# PLOTS
## Map of Sites in Massachusetts
These are the sites that have been input into the R shiny application. 
```{r Results_Site_Map}
library(ggplot2)
##### Massachusetts Map of Sites
## Color palette
region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")

## Map of MA
m1 <- ggplot(data = subset(map_data("state"), region %in% c("massachusetts"))) + 
            geom_polygon(aes(x=long, y=lat, group=group), fill="light gray", color="black") +
            coord_fixed(1.3)+
          labs(x= "Longitude",
               y= "Latitude")+
          theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")

## Add Points
m1 <- m1 + geom_point(data=df_metsc
                      , aes(LONG, LAT, color=INDEX_REGION), size = 2)

## Change colors
m1 <- m1 + scale_colour_manual(name="Index Region"
                               , values=region.colors)
## Print Plot
m1
```


## Overall Index Scores by Index Region
```{r Results_Index_Plot}
# Packages
library(ggplot2)
library(dplyr)

# Plot
region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582") # plot colors

# Western Highlands Scores

WH_data <- df_metsc %>% 
  filter(INDEX_REGION == "WESTHIGHLANDS") %>% 
  select_if(~sum(!is.na(.)) > 0)
  
if(dim(WH_data)[1]==0){
  cat("")
} else {
    p1 <- ggplot(WH_data, aes(x = Index, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(x= "Scores",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
} # end if else statement
# Central Hills Scores
CH_data <- df_metsc %>% 
  filter(INDEX_REGION == "CENTRALHILLS")%>% 
  select_if(~sum(!is.na(.)) > 0)
  
if(dim(CH_data)[1]==0){
  cat("")
} else {
      p2 <- ggplot(CH_data, aes(x = Index, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(x= "Scores",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
} # end if else statement
# Output

if(dim(WH_data)[1]==0){
  cat("")
} else {
  p1
} # end if statement

if(dim(CH_data)[1]==0){
  cat("")
} else {
  p2
} # end if statement

```

## Metric Values Distribution by Index Region.
Note, metrics are calculated, by BioMonTools package, for all Index Regions even if not applicable.

```{r Results_Metric_Values_Plots}
##### METRIC VALUES LOOP

#create table of metric names

col_metabbrev <- c("nt_total"
                 ,"pt_EPT"
                 ,"pi_EphemNoCaeBae"
                 ,"pi_ffg_filt"
                 ,"pt_ffg_pred"
                 ,"pt_tv_intol"
                 ,"pi_Pleco"
                 ,"pi_ffg_shred"
                 ,"pi_tv_intol"
                 ,"x_Becks")
col_metscore <- c("SC_nt_total"
                 ,"SC_pt_EPT"
                 ,"SC_pi_EphemNoCaeBae"
                 ,"SC_pi_ffg_filt"
                 ,"SC_pt_ffg_pred"
                 ,"SC_pt_tv_intol"
                 ,"SC_pi_Pleco"
                 ,"SC_pi_ffg_shred"
                 ,"SC_pi_tv_intol"
                 ,"SC_x_Becks")
col_metnames <- c("Total Taxa Richness"
                  , "% Plecoptera taxa"
                  , "% Ephem indiv (no Caenids or Baetids)"
                  , "% Filterer individuals"
                  , "% Predator taxa"
                  , "% Intolerant taxa"
                  , "% Plecoptera individuals"
                  , "% Shredder individuals"
                  , "% Intolerant individuals"
                  , "Becks Biotic Index")

df_metnames <- as.data.frame(cbind(col_metabbrev,col_metscore, col_metnames))
df_metnames <- df_metnames %>% 
  rename("Met_Names" = col_metnames,
         "Met_Scores" = col_metscore,
         "Met_Abbrev" = col_metabbrev)

# western highlands metrics
# for columns "ni_total" to ncol(df_metval)
WH_metval <- df_metval %>% 
  filter(INDEX_REGION == "WESTHIGHLANDS")

#start column
if(dim(WH_metval)[1]==0){
  start_col <- 0
} else {
  start_col <- which(colnames(WH_metval)=="nt_total")
} # end start_col statement

#end column
if(dim(WH_metval)[1]==0){
  end_col <- 0
} else {
  end_col <- ncol(WH_metval)
} # end end_col statement

# CREATE PLOTS - only if data are present
if(start_col == 0 & end_col == 0){
  cat("")
} else {

  metval_cols <- colnames(WH_metval[,start_col:end_col])

for(i in metval_cols){
  subset.data <- WH_metval[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  subset.metnames <- df_metnames %>% 
    filter(Met_Abbrev == i)
    
  
  title <- paste0(subset.metnames$Met_Names)
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")
  
  p3 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Units",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p3)

} # END of Loop
} # end if else statement

# central hills metrics
# for columns "ni_total" to ncol(df_metval)
CH_metval <- df_metval %>% 
  filter(INDEX_REGION == "CENTRALHILLS")

#start column
if(dim(CH_metval)[1]==0){
  start_col <- 0
} else {
  start_col <- which(colnames(CH_metval)=="nt_total")
} # end start_col statement

#end column
if(dim(CH_metval)[1]==0){
  end_col <- 0
} else {
  end_col <- ncol(CH_metval)
} # end end_col statement

# CREATE PLOTS - only if data are present
if(start_col == 0 & end_col == 0){
  cat("")
} else {

  metval_cols <- colnames(CH_metval[,start_col:end_col])

for(i in metval_cols){
  subset.data <- CH_metval[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  subset.metnames <- df_metnames %>% 
    filter(Met_Abbrev == i)
    
  
  title <- paste0(subset.metnames$Met_Names)
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")
  
  p4 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Units",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p4)

} # END of Loop
} # end if else statement

```

## Metric Scores Distribution by Index Region. 
Only metrics applied within each region are plotted.

```{r Results_Metric_Scores_Plots}
##### METRIC SCORES LOOP
# WESTERN HIGHLANDS
# for columns "ni_total" to ncol(df_metval)
# start column
if(dim(WH_data)[1]==0){
  start_col <- 0
} else {
  start_col <- which(colnames(WH_data)=="SC_nt_total")
} # end start_col statement

# end column
if(dim(WH_data)[1]==0){
  end_col <- 0
} else {
  end_col <- which(colnames(WH_data)=="SC_x_Becks")
} # end end_col statement

# CREATE PLOTS - only if data are present
if(start_col == 0 & end_col == 0){
  cat("")
} else {
  metsc_cols <- colnames(WH_data[,start_col:end_col])


for(i in metsc_cols){
  subset.data <- WH_data[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  subset.metnames <- df_metnames %>% 
    filter(Met_Scores == i)
    
  
  title <- paste0("Met Score - ", subset.metnames$Met_Names)
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  subset.data <- subset.data %>% filter(!is.na(Value))
  
  region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")
  
  p5 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Units",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p5)

} # END of Loop
} # end if else statement


# CENTRAL HILLS
# for columns "ni_total" to ncol(df_metval)

# start column
if(dim(CH_data)[1]==0){
  start_col <- 0
} else {
  start_col <- which(colnames(CH_data)=="SC_nt_total")
} # end start_col statement

# end column
if(dim(CH_data)[1]==0){
  end_col <- 0
} else {
  end_col <- which(colnames(CH_data)=="SC_pt_tv_intol")
} # end end_col statement

# CREATE PLOTS - only if data are present
if(start_col == 0 & end_col == 0){
  cat("")
} else {

metsc_cols <- colnames(CH_data[,start_col:end_col])

for(i in metsc_cols){
  subset.data <- CH_data[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  subset.metnames <- df_metnames %>% 
    filter(Met_Scores == i)
    
  
  title <- paste0("Met Score - ", subset.metnames$Met_Names)
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  subset.data <- subset.data %>% filter(!is.na(Value))
  
  region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")
  
  p5 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Units",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p5)

} # END of Loop
} # end if else statement

```
