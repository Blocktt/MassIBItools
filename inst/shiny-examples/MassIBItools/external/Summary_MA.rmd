---
title: "MassDEP Stream IBI Summary Report"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  word_document:
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: no
subtitle: Metric Scores and Values
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results='asis', echo=FALSE, warning=FALSE)
# needed for trouble shooting
boo_DEBUG <- FALSE
if(boo_DEBUG==TRUE){
  # myConfig <- file.path(system.file(package="ContDataQC"), "extdata", "config.ORIG.R")
  # source(myConfig)
}## IF ~ boo_DEBUG ~ END
```

# INTRODUCTION
The following document is dynamic - it changes depending on the data input into the Mass DEP R Shiny Application. 

Please refer to the "Data File Information" section for general properties of the input dataset used to genereate this report. 

Histograms in the "Plots" section will change depending on the input dataset. 

# DATA FILE INFORMATION
```{r data_file_info}
  # Results File
  df_metval <- df_metval
  df_metsc <- df_metsc
  
  # Report Info
  myReportDate <- format(Sys.time(), '%Y-%m-%d %H:%M:%S')
  cat(paste("**Report Date:** " ,myReportDate, "\n\n", sep=""))
  myUser <- Sys.getenv("USERNAME")
  cat(paste("**Generated By:** ", myUser, "\n\n", sep=""))
  
  # Number of Samples
  myNumRecords <- nrow(df_metval)
  cat(paste("**Number of Records:** ", myNumRecords, "\n\n", sep=""))
  
  # Period of Record
  POR <- paste(min(df_metval$COLLDATE)," to ", max(df_metval$COLLDATE), sep="")
  cat(paste("**Period of Record:** ", POR, sep="", collapse="\n\n"))
```

# SUMMARY TABLES
The tables below summarize the data that were input into the shiny app.
```{r Results_summary_table1, message=FALSE}
library(knitr)
library(tidyr)

df_scores <- df_metsc
df_scores$counts <- rep(1)

table1 <- df_scores %>% 
  group_by(Index_Nar, INDEX_REGION) %>% 
  summarize(counts = sum(counts)) %>% 
  pivot_wider(names_from = INDEX_REGION,
              values_from = counts) %>% 
  rename("Index Narrative" = Index_Nar,
         "Central Hills" = CENTRALHILLS,
         "Western Highlands" = WESTHIGHLANDS)

kable(table1, caption = "Number of sites by Index Narrative and Index Region")

```

```{r Results_summary_table2, message=FALSE}
library(knitr)
library(tidyr)

scores_trim <- df_scores %>% 
  select(INDEX_REGION, Index, counts)

table2 <- scores_trim %>% 
  group_by(INDEX_REGION) %>% 
  summarize(N = sum(counts),
            Min = round(min(Index), 1),
            q25 = round(quantile(Index, 0.25, na.rm = TRUE), 1),
            Med = round(median(Index, na.rm = TRUE), 1),
            q75 = round(quantile(Index, 0.75, na.rm = TRUE), 1),
            Max = round(max(Index),1))

kable(table2, caption = "Index scores summary statistics by Index Region")

```
# PLOTS
## Map of Sites in Massachusetts
These are the sites that have been input into the R shiny application. 
```{r Results_Site_Map}
##### Massachusetts Map of Sites
## Color palette
region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")

## Map of MA
m1 <- ggplot(data = subset(map_data("state"), region %in% c("massachusetts"))) + 
            geom_polygon(aes(x=long, y=lat, group=group), fill="light gray", color="black") +
            coord_fixed(1.3)+
          labs(x= "Longitude",
               y= "Latitude")+
          theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")

## Add Points
m1 <- m1 + geom_point(data=df_metsc
                      , aes(LONG, LAT, color=INDEX_REGION), size = 2)

## Change colors
m1 <- m1 + scale_colour_manual(name="Index Region"
                               , values=region.colors)
## Print Plot
m1
```


## Overall Index Scores by Index Region
```{r Results_Index_Plot}
# Packages
library(ggplot2)

# Plot
region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582") # plot colors

  p1 <- ggplot(df_metsc, aes(x = Index, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(x= "Scores",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")





# Output
p1
```

## Metric Values Distribution by Index Region.
Note, metrics are calculated, by BioMonTools package, for all Index Regions even if not applicable. 
```{r Results_Metric_Values_Plots}
##### METRIC VALUES LOOP

# for columns "ni_total" to ncol(df_metval)
start_col<- which(colnames(df_metval)=="ni_total")
end_col <- ncol(df_metval)

metval_cols <- colnames(df_metval[,start_col:end_col])

for(i in metval_cols){
  subset.data <- df_metval[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  title <- paste0(i, " - by Index Region")
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")
  
  p2 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Units",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  print(p2)

} # END of Loop
```

## Metric Scores Distribution by Index Region. 
Only metrics applied within each region are plotted.
```{r Results_Metric_Scores_Plots}
##### METRIC SCORES LOOP

# for columns "ni_total" to ncol(df_metval)
start_col<- which(colnames(df_metsc)=="SC_nt_total")
end_col <- which(colnames(df_metsc)=="SC_x_Becks")

metsc_cols <- colnames(df_metsc[,start_col:end_col])

for(i in metsc_cols){
  subset.data <- df_metsc[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  title <- paste0(i, " - by Index Region")
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  subset.data <- subset.data %>% filter(!is.na(Value))
  
  region.colors <- c("CENTRALHILLS" = "#1f78b4", "WESTHIGHLANDS"= "#f4a582")
  
  p3 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Units",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p3)

} # END of Loop
```
